PostgreSQLのバージョンは9.2.4
192.168.0.119	postgresql1
192.168.0.120	postgresql2

クライアントは192.168.0.118

yum install -y gcc-c++ make readline-devel zlib-devel

リポジトリ追加
rpm -ivh http://yum.postgresql.org/9.2/redhat/rhel-5-x86_64/pgdg-centos92-9.2-7.noarch.rpm

vi /etc/yum.repos.d/CentOS-Base.repo
#####[base]の末尾に下記を追加しbaseリポジトリのpostgresqlを利用しないようにする
exclude=postgresql*
#####

yum search postgresql

yum install postgresql-server postgresql-devel postgresql-contrib
クライアントのみ入れたい場合は yum install postgresql
クライアントとpgbenchを使う場合はyum install postgresql postgresql-contrib
chkconfig postgresql-9.2 on on

service postgresql-9.2 initdb
service postgresql-9.2 start


su - postgres

/usr/pgsql-9.2/bin/pg_ctl start -D /var/lib/pgsql/9.2/data -l ~/9.2/master.log
createdb --encoding=UTF8 --template=template1 testdb
/usr/pgsql-9.2/bin/pgbench -i testdb
/usr/pgsql-9.2/bin/pgbench testdb -c 3 -t 500 -p 5432

/var/lib/pgsql/9.2/dat

vi postgresql.conf
##########
wal_level = hot_standby           # レプリケーション対応
		synchronous_commitパラメータでレプリケーションの同期方式を設定します。
		? 同期：on 
		? メモリ同期：remote_write 
		? スレーブ非同期：local 
		? 完全非同期：off 
synchronous_commit = remote_write # メモリ同期レプリケーション
max_wal_senders = 3               # とりあえずスレーブ2台まで
synchronous_standby_names = 'slave1'   
wal_keep_segments = 16
##########

vi pg_hba.conf
##########全てコメントアウトして以下にする
host    replication     postgres        ::1/128                 trust <--identからtrustに変更
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust
local   replication     postgres                                trust
host    replication     postgres        127.0.0.1/32            trust
##########


exit
service postgresql-9.2 restart

su - postgres

スレーブ用のバックアップデータ取得

/usr/pgsql-9.2/bin/pg_basebackup -h localhost -p 5432 -D ~/9.2/data_slave --xlog --progress --verbose

スレーブサーバ用に設定ファイルを編集
【~/9.2/data_slave/postgresql.conf】
hot_standby = on
log_line_prefix = '[slave1]'  # 必須じゃないけど一応スレーブの名前をつける

recovery.confをサンプルからコピー
$ cp /usr/pgsql-9.2/share/recovery.conf.sample ~/9.2/data_slave/recovery.conf
【~/9.2/data_slave/recovery.conf】
standby_mode = on
primary_conninfo = 'host=postgres1 port=5432 application_name=slave1'


スレーブにバックアップデータ転送
rsync -ahv data_slave/ postgresql2:/var/lib/pgsql/9.2/data/

スレーブ側postgres起動
service postgresql-9.2 start


スレーブ側がinsert出来ないことを確認
psql -p 5432 -c "INSERT INTO pgbench_history VALUES (1,1,1,1,now())" testdb
ERROR:  リードオンリーのトランザクションでは INSERT を実行できません

psql -p 5432 -c "SELECT application_name,state,sync_priority,sync_state FROM pg_stat_replication"




testdbへ接続
psql testdb

update pgbench_accounts set abalance=0 where aid=1
なぜかセミコロンをつけると応答が返ってこなくなる


UPDATE 表名 
SET 列名 = 値,列名 = 値... 
WHERE 条件 


select * from pgbench_accounts where aid=1;










PGLOG=/var/lib/pgsql/9.2/pgstartup.log
# Log file for pg_upgrade
PGUPLOG=/var/lib/pgsql/$PGMAJORVERSION/pgupgrade.log













































