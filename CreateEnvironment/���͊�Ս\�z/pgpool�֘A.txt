

yum -y install http://www.pgpool.net/yum/rpms/3.4/redhat/rhel-6-x86_64/pgpool-II-pg92-3.4.6-1pgdg.rhel6.x86_64.rpm

vi /etc/pgpool-II/pgpool.conf
		データベースの接続情報
		backend_hostname0 = '10.0.1.10'
		backend_port0 = 5432

		コネクションプールの設定
		num_init_children = 64 # pgpoolへの接続数
		max_pool = 1           # DBユーザ名・データベース名毎に一つ

		オンメモリクエリキャッシュの設定
		memory_cache_enabled = on # 有効にする
		
		接続アプリケーションによって接続先DBを変える
		app_name_redirect_preference_list = 'アプリケーション名:接続先DBノード番号(若しくはprimary、standby)'
		常にスタンバイサーバだけに検索クエリを投げるようにする場合
		app_name_redirect_preference_list: .*:standby
		pgpool.confの設定を変更した場合はpgpoolを再起動する必要があります。
		また、pgpool.confのbackend設定はpgpoolを起動するとpgpool_statusに記録されてしまい、設定ファイルを編集しても変更が適用されなくなってしまいます。
		そうなってしまった場合は起動時に-Dオプションをつけてpgpool_statusを削除してください

##########

mkdir /var/run/pgpool

mkdir /var/log/pgpool

useradd postgres
passwd postgres

chown postgres:postgres /var/log/pgpool/
chown postgres:postgres /var/run/pgpool/
vi /etc/pgpool-II/pool_passwd   ----------->空のファイル
ls -ltr /etc/pgpool-II/pool_passwd 
chown postgres:postgres /etc/pgpool-II/pool_passwd
chkconfig pgpool on
service pgpool start

psql -h localhost -p 9999 -U repl_user -d testdb
psql -h localhost -p 9999 -U repl_user -d testdb -c "select * from pgbench_accounts where aid=1;"

pcp.conf にアカウントパスワードを設定する？
pg_md5 postgres　MD5作成





############################################
パスワードをどうするか
・各アカウントのホームディレクトリに.pgpassを作る方法
・環境変数を作る方法

##########
各アカウントのホームディレクトリに.pgpassを作る方法
cat .pgpass
#ホスト名:ポート:データベース:ユーザ:パスワード
192.168.0.118:9999:testdb:repl_user:postgres

chmod 600 .pgpass

##########
環境変数を作る方法
export PGPASSWORD=postgres
export PGHOST=192.168.0.118
export PGPORT=9999
export PGDATABASE=testdb
export PGUSER=repl_user

psql -c "/*NO LOAD BALANCE*/ select * from pgbench_accounts where aid=1;"
psql -c "select * from pgbench_accounts where aid=1;"

設定ファイルを作っておいて状況に応じてsourceで読み込んでいけるのでこっちが楽
##########

psql -h postgresql2 -p 5432 -U repl_user -d testdb -c "select * from pgbench_accounts where aid=1;"


psql -h localhost -p 5432 -c "SELECT application_name,state,sync_priority,sync_state FROM pg_stat_replication"



/usr/bin/pgpool -f /etc/pgpool-II/pgpool.conf 

##########読み取り先の制御##########
pgpool.confの設定
app_name_redirect_preference_list = 'postgresql2:standby'
app_name_redirect_preference_list = 'postgresql1:primary'


クライアント側の環境変数で参照先の制御を行う
export PGAPPNAME=postgresql2
psql -c "select * from pgbench_accounts where aid=2;"


export PGAPPNAME=postgresql1
psql -c "select * from pgbench_accounts where aid=1;"













