

./configure --with-pgsql=/usr/pgsql-9.4


-bash-4.1$ pgpool_setup
Satrting set up in streaming replication mode
creating startall and shutdownall
creating failover script
creating database cluster /opt/test/data0...done.
update postgreql.conf
creating pgpool_remote_start
creating basebackup.sh
creating recovery.conf
creating database cluster /opt/test/data1...done.
update postgreql.conf
creating pgpool_remote_start
creating basebackup.sh
creating recovery.conf
temporarily start data0 cluster to create extensions
temporarily start pgpool-II to create standby nodes
 node_id | hostname | port  | status | lb_weight |  role
---------+----------+-------+--------+-----------+---------
 0       | /tmp     | 11002 | 2      | 0.500000  | primary
 1       | /tmp     | 11003 | 3      | 0.500000  | standby
(2 行)

recovery node 1...BackendError
done.
creating follow master script
 node_id | hostname | port  | status | lb_weight |  role
---------+----------+-------+--------+-----------+---------
 0       | /tmp     | 11002 | 2      | 0.500000  | primary
 1       | /tmp     | 11003 | 3      | 0.500000  | standby
(2 行)

shutdown all

pgpool-II setting for streaming replication mode is done.
To start the whole system, use /opt/test/startall.
To shutdown the whole system, use /opt/test/shutdownall.
pcp command user name is "postgres", password is "postgres".
Each PostgreSQL, pgpool-II and pcp port is as follows:
#1 port is 11002
#2 port is 11003
pgpool port is 11000
pcp port is 11001
The info above is in README.port.
-bash-4.1$


サーバの起動完了を待っています....1431 2015-12-09 19:26:14 JST LOG:  redirecting log output to logging collector process
1431 2015-12-09 19:26:14 JST HINT:  Future log output will appear in directory "pg_log".
完了
サーバ起動完了
ERROR:  could not stat file "/usr/pgsql-9.4/share/extension/pgpool_regclass--1.0.sql": No such file or directory
ERROR:  could not stat file "/usr/pgsql-9.4/share/extension/pgpool_recovery--1.1.sql": No such file or directory
CREATE DATABASE

-rw-r--r--  1 root root   178 12月  9 19:11 2015 pgpool_recovery.control
-rw-r--r--  1 root root   152 12月  9 19:11 2015 pgpool_regclass.control
-rw-r--r--  1 root root   283 12月  9 19:22 2015 pgpool_regclass--1.0.sql
-rw-r--r--  1 root root  1002 12月  9 19:23 2015 pgpool_recovery--1.1.sql

module_pathname = '$libdir/pgpool-recovery'
module_pathname = '$libdir/pgpool-regclass'


$PSQL -p $BASEPORT template1 >&5 2>&1 <<EOF
CREATE EXTENSION pgpool_regclass;
CREATE EXTENSION pgpool_recovery;
CREATE DATABASE test;
EOF

-bash-4.1$ sudo find / -name pgpool-recovery
/var/lib/pgsql/download/pgpool-II-3.4.3/src/sql/pgpool-recovery


-bash-4.1$ sudo find / -name pgpool-regclass
/var/lib/pgsql/download/pgpool-II-3.4.3/src/sql/pgpool-regclass


/











yumコマンドでインストール
yum install http://www.pgpool.net/yum/rpms/3.4/redhat/rhel-7-x86_64/pgpool-II-pg94-3.4.3-1pgdg.rhel7.x86_64.rpm

cd /etc/pgpool-II/
今回はストリーミングレプリケーションモードを使用するので雛形からコピー
cp pgpool.conf.sample-stream pgpool.conf
vi pgpool.conf
		sr_check_user = 'zabbix' ->nobodyから変更
pg_md5 zabbix
結果をpcp.confに書く
vi pcp.conf

必要かどうか確認（ストリーミングレプリケーション利用時はmd5認証は使えない？）->（多分）いらない
vi pool_passwd



今回はクライアント認証：HBA（host-based authentication: ホストベース認証）を使う（設定は甘々）
vi pool_hba.conf

ログ格納場所作成
cd /var/log
mkdir pgpool

pidファイル配置用ディレクトリ作成
cd /var/run
ls
mkdir pgpool

取り敢えず起動
pgpool -n -d > /var/log/pgpool/pgpool.log 2>&1 &

ログ確認
tailf /var/log/pgpool/pgpool.log


停止
pgpool stop

クライアントの接続が切断されるまで待たない
pgpool -m fast stop


#################DB障害シミュレート###################

Masterのpostgresqlを停止(immediateでないとpgpoolがコネクションを張っているので停止出来ない)
$pg_ctl stop -m immediate

postgresqlを起動
$pg_ctl start




#################Zabbix-server起動停止###################

systemctl status zabbix-server

systemctl start zabbix-server

systemctl stop zabbix-server
















































































